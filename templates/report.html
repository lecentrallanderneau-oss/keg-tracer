{% extends "base.html" %}
{% block title %}Rapports · Suivi des Fûts{% endblock %}
{% block content %}

<h2>Rapport</h2>

<form method="get" action="{{ url_for('report') }}" style="display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0,1fr)); max-width:800px;">
  <div>
    <label>Client</label>
    <select name="client_id">
      <option value="">— Tous —</option>
      {% for c in clients %}
        <option value="{{ c.id }}" {% if selected_client_id==c.id %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Bière</label>
    <select name="beer_id">
      <option value="">— Toutes —</option>
      {% for b in beers %}
        <option value="{{ b.id }}" {% if selected_beer_id==b.id %}selected{% endif %}>{{ b.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Période rapide</label>
    <select name="months_back">
      <option value="">— Personnalisée —</option>
      <option value="0" {% if months_back==0 %}selected{% endif %}>Ce mois</option>
      <option value="1" {% if months_back==1 %}selected{% endif %}>M-1</option>
      <option value="3" {% if months_back==3 %}selected{% endif %}>3 derniers mois</option>
      <option value="6" {% if months_back==6 %}selected{% endif %}>6 derniers mois</option>
      <option value="12" {% if months_back==12 %}selected{% endif %}>12 derniers mois</option>
    </select>
  </div>
  <div>
    <label>Du</label>
    <input type="date" name="from" value="{{ start.isoformat() if start else '' }}">
  </div>
  <div>
    <label>Au</label>
    <input type="date" name="to" value="{{ end.isoformat() if end else '' }}">
  </div>
  <div style="align-self:end;">
    <button type="submit">Filtrer</button>
  </div>
</form>

<h3 style="margin-top:18px;">Synthèse</h3>
<ul>
  <li>Livrés : <strong>{{ delivered or 0 }}</strong></li>
  <li>Retours pleins : <strong>{{ returned_full or 0 }}</strong></li>
  <li>Retours vides : <strong>{{ returned_empty or 0 }}</strong></li>
  <li>Consignes facturées : <strong>{{ (consigne_charged or 0)|float|round(2) }}</strong></li>
  <li>Consignes remboursées : <strong>{{ (consigne_refunded or 0)|float|round(2) }}</strong></li>
</ul>

<h3>Détail par bière</h3>
<div class="table-responsive">
  <table>
    <thead>
      <tr>
        <th>Bière</th>
        <th>Livrés</th>
        <th>Retours pleins</th>
        <th>Retours vides</th>
      </tr>
    </thead>
    <tbody>
      {% for beer_name, data in (breakdown or {}).items() %}
      <tr>
        <td>{{ beer_name }}</td>
        <td>{{ data.delivered }}</td>
        <td>{{ data.returned_full }}</td>
        <td>{{ data.returned_empty }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Aucune donnée sur la période.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<h3>Mouvements sur la période</h3>
<div class="table-responsive">
  <table>
    <thead>
      <tr>
        <th>Date</th><th>Type</th><th>Client</th><th>Bière</th><th>Qté</th><th>Consigne/fût</th><th>Notes</th>
      </tr>
    </thead>
    <tbody>
      {% for m in moves %}
      <tr>
        <td>{{ m.dt.isoformat() if m.dt else '' }}</td>
        <td>
          {% if m.mtype=='delivery' %}Livraison
          {% elif m.mtype=='return_full' %}Retour plein
          {% elif m.mtype=='return_empty' %}Retour vide
          {% else %}{{ m.mtype }}{% endif %}
        </td>
        <td>{{ m.client.name if m.client else '' }}</td>
        <td>{{ m.beer.name if m.beer else '' }}</td>
        <td>{{ m.qty or 0 }}</td>
        <td>{{ ((m.consigne_per_keg or 0)|float)|round(2) }}</td>
        <td>{{ m.notes or '' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="7">Aucun mouvement sur cette période.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}
