{% extends "base.html" %}
{% block title %}Rapports · Suivi des Fûts{% endblock %}
{% block content %}

<h2>Rapport</h2>

<form method="get" action="{{ url_for('report') }}" style="display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0,1fr)); max-width:800px;">
  <div>
    <label>Client</label>
    <select name="client_id">
      <option value="">— Tous —</option>
      {% for c in clients %}
        <option value="{{ c.id }}" {% if selected_client_id==c.id %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Bière</label>
    <select name="beer_id">
      <option value="">— Toutes —</option>
      {% for b in beers %}
        <option value="{{ b.id }}" {% if selected_beer_id==b.id %}selected{% endif %}>{{ b.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Période rapide</label>
    <select name="months_back">
      <option value="">— Personnalisée —</option>
      <option value="0" {% if months_back==0 %}selected{% endif %}>Ce mois</option>
      <option value="1" {% if months_back==1 %}selected{% endif %}>M-1</option>
      <option value="3" {% if months_back==3 %}selected{% endif %}>3 derniers mois</option>
      <option value="6" {% if months_back==6 %}selected{% endif %}>6 derniers mois</option>
      <option value="12" {% if months_back==12 %}selected{% endif %}>12 derniers mois</option>
    </select>
  </div>
  <div>
    <label>Du</label>
    <input type="date" name="from" value="{{ start }}">
  </div>
  <div>
    <label>Au</label>
    <input type="date" name="to" value="{{ end }}">
  </div>
  <div style="align-self:end;">
    <button type="submit">Filtrer</button>
  </div>
</form>

<h3 style="margin-top:18px;">Synthèse</h3>
<ul>
  <li>Livrés : <strong>{{ delivered }}</strong></li>
  <li>Retours pleins : <strong>{{ returned_full }}</strong></li>
  <li>Retours vides : <strong>{{ returned_empty }}</strong></li>
  <li>Consignes facturées : <strong>{{ '%.2f'|format(consigne_charged) }}</strong></li>
  <li>Consignes remboursées : <strong>{{ '%.2f'|format(consigne_refunded) }}</strong></li>
</ul>

<h3>Détail par bière</h3>
<div class="table-responsive">
  <table>
    <thead>
      <tr>
        <th>Bière</th>
        <th>Livrés</th>
        <th>Retours pleins</th>
        <th>Retours vides</th>
      </tr>
    </thead>
    <tbody>
      {% for beer_name, data in breakdown.items() %}
      <tr>
        <td>{{ beer_name }}</td>
        <td>{{ data.delivered }}</td>
        <td>{{ data.returned_full }}</td>
        <td>{{ data.returned_empty }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Aucune donnée sur la période.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<h3>Mouvements sur la période</h3>
<div class="table-responsive">
  <table>
    <thead>
      <tr>
        <th>Date</th><th>Type</th><th>Client</th><th>Bière</th><th>Qté</th><th>Consigne/fût</th><th>Notes</th>
      </tr>
    </thead>
    <tbody>
      {% for m in moves %}
      <tr>
        <td>{{ m.dt }}</td>
        <td>{{ 'Livraison' if m.mtype=='delivery' else ('Retour plein' if m.mtype=='return_full' else 'Retour vide') }}</td>
        <td>{{ m.client.name }}</td>
        <td>{{ m.beer.name }}</td>
        <td>{{ m.qty }}</td>
        <td>{{ '%.2f'|format(m.consigne_per_keg) }}</td>
        <td>{{ m.notes or '' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="7">Aucun mouvement sur cette période.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}
