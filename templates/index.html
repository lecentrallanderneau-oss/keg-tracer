{% extends "base.html" %}

{% block title %}Dashboard — Keg Tracer{% endblock %}

{% block content %}
<h1>Dashboard</h1>
<p class="muted">Période : {{ current_month_label|default('—') }} · Build {{ build_version|default('dev') }} · Sync {{ last_sync|default('—') }}</p>

<div class="kpis">
  <div class="card">
    <div class="muted">Solde consignes</div>
    <div style="font-size:1.8rem;font-weight:700">{{ '{:,.2f}'.format((consigne_balance|default(0)|float)) }} €</div>
  </div>
  <div class="card">
    <div class="muted">Fûts en stock</div>
    <div style="font-size:1.8rem;font-weight:700">{{ total_kegs|default(0) }}</div>
  </div>
  <div class="card">
    <div class="muted">Livraisons (mois)</div>
    <div style="font-size:1.8rem;font-weight:700">{{ deliveries_this_month|default(0) }}</div>
  </div>
  <div class="card">
    <div class="muted">Retours en attente</div>
    <div style="font-size:1.8rem;font-weight:700">{{ pending_returns|default(0) }}</div>
  </div>
</div>

<div class="card">
  <h2 style="margin-top:0">Dernières livraisons</h2>
  {% set items = recent_deliveries|default([], true) %}
  {% if items %}
    <table>
      <thead>
        <tr><th>Date</th><th>Fournisseur</th><th>Produit</th><th>Qté</th><th>Consigne</th><th>Facture</th></tr>
      </thead>
      <tbody>
        {% for d in items %}
        <tr>
          <td>{{ d.date|default('—') }}</td>
          <td>{{ d.supplier|default('—') }}</td>
          <td>{{ d.product|default('—') }}</td>
          <td>{{ d.quantity|default(0) }}</td>
          <td>{{ '{:,.2f}'.format((d.deposit|default(0)|float)) }} €</td>
          <td>{{ d.invoice_no|default('—') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Aucune livraison récente.</p>
  {% endif %}
</div>

<div class="card">
  <h2 style="margin-top:0">Fûts en circulation</h2>
  {% set k = kegs_in_circulation|default([], true) %}
  {% if k %}
    <table>
      <thead>
        <tr><th>ID</th><th>Produit</th><th>L</th><th>Statut</th><th>Localisation</th><th>MàJ</th></tr>
      </thead>
      <tbody>
        {% for keg in k %}
        <tr>
          <td>{{ keg.id|default('—') }}</td>
          <td>{{ keg.product|default('—') }}</td>
          <td>{{ keg.size_l|default('—') }}</td>
          <td>{{ keg.status|default('unknown') }}</td>
          <td>{{ keg.location|default('—') }}</td>
          <td>{{ keg.updated_at|default('—') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Aucun fût en circulation.</p>
  {% endif %}
</div>
{% endblock %}
