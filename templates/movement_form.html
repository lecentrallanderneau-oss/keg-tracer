{% extends "base.html" %}
{% block title %}Nouveau mouvement · Suivi des Fûts{% endblock %}
{% block content %}

<h2>Ajouter un mouvement</h2>

<form id="mv-form" class="card" onsubmit="return submitMovement(event)">
  <div class="grid-2">
    <div>
      <label for="dt">Date</label>
      <input type="date" id="dt" name="dt" value="{{ today_iso }}" required>
    </div>
    <div>
      <label for="mtype">Type</label>
      <select id="mtype" name="mtype" required>
        <option value="delivery">Livraison</option>
        <option value="return_full">Retour plein</option>
        <option value="return_empty">Retour vide</option>
      </select>
    </div>

    <div>
      <label for="client_id">Client</label>
      <select id="client_id" name="client_id" required>
        {% for c in clients %}
          <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="beer_id">Bière</label>
      <select id="beer_id" name="beer_id" required>
        {% for b in beers %}
          <option value="{{ b.id }}">{{ b.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="qty">Quantité (fûts)</label>
      <input type="number" id="qty" name="qty" min="1" step="1" value="1" required>
    </div>

    <div>
      <label for="consigne_per_keg">Consigne par fût (€)</label>
      <input type="number" id="consigne_per_keg" name="consigne_per_keg" min="0" step="0.01" value="0">
    </div>

    <div class="full">
      <label for="notes">Notes</label>
      <textarea id="notes" name="notes" rows="2" placeholder="Optionnel"></textarea>
    </div>
  </div>

  <div class="actions">
    <button type="submit">Enregistrer</button>
    <a class="btn-secondary" href="{{ url_for('movements') }}">Annuler</a>
  </div>

  <p id="mv-msg" class="muted" style="display:none;"></p>
</form>

<script>
async function submitMovement(ev) {
  ev.preventDefault();
  const form = document.getElementById('mv-form');
  const msg  = document.getElementById('mv-msg');
  msg.style.display = 'none';

  const payload = {
    dt:              document.getElementById('dt').value,
    mtype:           document.getElementById('mtype').value,
    client_id:       document.getElementById('client_id').value,
    beer_id:         document.getElementById('beer_id').value,
    qty:             document.getElementById('qty').value || 1,
    consigne_per_keg:document.getElementById('consigne_per_keg').value || 0,
    notes:           document.getElementById('notes').value || ''
  };

  try {
    const r = await fetch('{{ url_for("api_movement") }}', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await r.json();

    if (!r.ok || !data.ok) {
      throw new Error((data && data.error) || 'Erreur inconnue');
    }

    if (data.dedup) {
      msg.textContent = 'Mouvement déjà saisi à l’identique il y a quelques secondes. Pas de doublon.';
      msg.style.display = 'block';
    }

    window.location.href = '{{ url_for("movements") }}';
    return false;
  } catch (e) {
    msg.textContent = 'Erreur : ' + (e.message || e);
    msg.style.display = 'block';
    return false;
  }
}
</script>

{% endblock %}
